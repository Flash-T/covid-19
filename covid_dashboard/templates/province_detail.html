{% extends 'base.html' %}

{% block title %}{{ province.name }}疫情数据 - COVID-19疫情数据分析平台{% endblock %}

{% block content %}
<div class="container">
    <!-- 返回按钮 -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="{% url 'covid_data:index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> 返回首页
            </a>
        </div>
    </div>
    
    <!-- 省份标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-primary">
                <h4 class="mb-0">
                    <i class="fas fa-map-marker-alt"></i> 
                    {{ province.name }}疫情数据
                    <small class="text-muted">({{ date }})</small>
                </h4>
            </div>
        </div>
    </div>
    
    <!-- 省份数据概览 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="data-card data-card-confirmed">
                <h5 class="data-title">累计确诊</h5>
                <div class="data-value" id="confirmedCount">{{ province.confirmed }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="data-card data-card-cured">
                <h5 class="data-title">累计治愈</h5>
                <div class="data-value" id="curedCount">{{ province.cured }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="data-card data-card-dead">
                <h5 class="data-title">累计死亡</h5>
                <div class="data-value" id="deadCount">{{ province.dead }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="data-card" style="background-color: #e9ecef; border-left: 4px solid #6c757d;">
                <h5 class="data-title">正在治疗</h5>
                <div class="data-value" id="treatingCount">{{ province.treating }}</div>
            </div>
        </div>
    </div>
    
    {% if province.comment %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i> {{ province.comment }}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 图表区域 -->
    <div class="row">
        <!-- 省份饼图 -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-chart-pie"></i> {{ province.name }}疫情统计</h5>
                <div id="province-pie" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
        
        <!-- 城市排行 -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5><i class="fas fa-chart-bar"></i> {{ province.name }}城市疫情统计</h5>
                <div id="city-bar" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>
    
    <!-- 城市数据表格 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container">
                <h5><i class="fas fa-table"></i> 城市数据列表</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>城市</th>
                                <th>确诊</th>
                                <th>治愈</th>
                                <th>死亡</th>
                                <th>正在治疗</th>
                            </tr>
                        </thead>
                        <tbody id="cityTableBody">
                            <!-- 城市数据将通过JavaScript填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // 加载省份详情数据
        loadProvinceDetailData();
    });
    
    function loadProvinceDetailData() {
        $.ajax({
            url: "{% url 'covid_data:province_detail' province_name=province.short_name %}",
            type: "GET",
            dataType: "json",
            success: function(response) {
                // 更新省份数据
                $("#confirmedCount").text(formatNumber(response.province.confirmed));
                $("#curedCount").text(formatNumber(response.province.cured));
                $("#deadCount").text(formatNumber(response.province.dead));
                
                const treating = response.province.confirmed - response.province.cured - response.province.dead;
                $("#treatingCount").text(formatNumber(treating));
                
                // 渲染饼图
                if (response.pie_options) {
                    const pieChart = echarts.init(document.getElementById('province-pie'));
                    pieChart.setOption(JSON.parse(response.pie_options));
                    
                    // 窗口大小变化时调整图表大小
                    window.addEventListener('resize', function() {
                        pieChart.resize();
                    });
                }
                
                // 渲染柱状图
                if (response.bar_options) {
                    const barChart = echarts.init(document.getElementById('city-bar'));
                    barChart.setOption(JSON.parse(response.bar_options));
                    
                    // 窗口大小变化时调整图表大小
                    window.addEventListener('resize', function() {
                        barChart.resize();
                    });
                }
                
                // 填充城市数据表格
                const cityTableBody = $("#cityTableBody");
                cityTableBody.empty();
                
                if (response.cities && response.cities.length > 0) {
                    response.cities.forEach(function(city) {
                        const treating = city.confirmed - city.cured - city.dead;
                        const row = `
                            <tr>
                                <td>${city.name}</td>
                                <td>${formatNumber(city.confirmed)}</td>
                                <td>${formatNumber(city.cured)}</td>
                                <td>${formatNumber(city.dead)}</td>
                                <td>${formatNumber(treating)}</td>
                            </tr>
                        `;
                        cityTableBody.append(row);
                    });
                } else {
                    cityTableBody.append(`
                        <tr>
                            <td colspan="5" class="text-center">暂无城市数据</td>
                        </tr>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error("加载省份数据失败:", error);
                alert("加载省份数据失败，请稍后重试");
            }
        });
    }
</script>
{% endblock %} 
 